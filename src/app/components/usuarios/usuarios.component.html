<div class="usuarios-container">
  <app-sidebar></app-sidebar>
  
  <div class="main-content">
    <div class="header">
      <h1 class="welcome">¡Bienvenido/a, <span class="user-name">{{ currentUser }}</span>!</h1>
    </div>

    <div class="content-area">
      <h2 class="page-title">GESTION DE USUARIOS</h2>

      <div class="actions-bar">
        <div class="search-wrapper">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
            <circle cx="9" cy="9" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M13 13 L17 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Buscar..."
            [(ngModel)]="searchTerm"
            (input)="onSearch()">
        </div>
        <button class="add-button" (click)="openAddModal()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M10 5 L10 15 M5 10 L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Crear Usuario
        </button>
      </div>

      <div class="table-container">
        <table class="usuarios-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Fecha Registro</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of filteredUsuarios">
              <td>{{ usuario.nombre }}</td>
              <td>{{ usuario.email }}</td>
              <td>
                <span class="rol-badge" 
                      [class.admin]="getRolNombre(usuario.idRol, usuario) === 'Admin' || getRolNombre(usuario.idRol, usuario) === 'ADMINISTRADOR' || getRolNombre(usuario.idRol, usuario) === 'Administrador'" 
                      [class.coordinador]="getRolNombre(usuario.idRol, usuario) === 'Coordinador' || getRolNombre(usuario.idRol, usuario) === 'COORDINADOR'" 
                      [class.docente]="getRolNombre(usuario.idRol, usuario) === 'Docente' || getRolNombre(usuario.idRol, usuario) === 'DOCENTE'"
                      [class.usuario]="getRolNombre(usuario.idRol, usuario) === 'Usuario' || getRolNombre(usuario.idRol, usuario) === 'USUARIO'">
{{ usuario.rol?.nombre || getRolNombre(usuario.idRol, usuario) }}
                </span>
              </td>
              <td>{{ formatDate(usuario.fechaRegistro) }}</td>
              <td>
                <span class="status-badge" [class.active]="usuario.estado" [class.inactive]="!usuario.estado">
                  {{ usuario.estado ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="action-btn block-btn" (click)="toggleEstado(usuario)" [title]="usuario.estado ? 'Desactivar' : 'Activar'">
                    <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                      <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                      <line x1="6" y1="6" x2="14" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                  <button class="action-btn delete-btn" (click)="deleteUsuario(usuario)" title="Eliminar">
                    <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                      <path d="M5 5 L15 15 M15 5 L5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                  <button class="action-btn edit-btn"
                    (click)="openEditModal(usuario)"
                     title="Editar">
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                       <path d="M4 14 L14 4" stroke="currentColor" stroke-width="2"/>
                     <path d="M4 14 L4 16 L6 16 L16 6 L14 4 Z"
                          stroke="currentColor"
                          stroke-width="2"
                          fill="none"/>
                     </svg>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredUsuarios.length === 0">
              <td colspan="6" class="no-data">No hay usuarios registrados</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Crear Usuario -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeAddModal()">×</button>
    <h2 class="modal-title">Crear Usuario</h2>
    
    <form class="modal-form" (ngSubmit)="saveUsuario()">
      <div class="form-fields">
        <div class="form-field">
          <label>Nombre Completo *</label>
          <input type="text" [(ngModel)]="nuevoUsuario.nombre" name="nombre" placeholder="Nombre del usuario" required>
        </div>
        <div class="form-field">
          <label>Email *</label>
          <input type="email" [(ngModel)]="nuevoUsuario.email" name="email" placeholder="usuario@ejemplo.com" required>
        </div>
        <div class="form-field">
          <label>Contraseña *</label>
          <div class="input-wrapper">
            <input 
              [type]="showPassword ? 'text' : 'password'" 
              [(ngModel)]="passwordTemp" 
              name="password" 
              placeholder="Contraseña segura" 
              required>
            <button 
              type="button" 
              class="eye-icon" 
              [class.eye-open]="showPassword"
              [class.eye-closed]="!showPassword"
              (click)="togglePasswordVisibility()">
              <!-- Ojo abierto -->
              <svg *ngIf="showPassword" width="20" height="20" viewBox="0 0 20 20" fill="none" class="eye-svg">
                <path d="M10 4 C6 4 3 6 1 10 C3 14 6 16 10 16 C14 16 17 14 19 10 C17 6 14 4 10 4 Z" 
                      stroke="currentColor" stroke-width="1.5" fill="none" class="eye-outline"/>
                <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5" fill="none" class="eye-pupil"/>
                <circle cx="10" cy="10" r="1.5" fill="currentColor" class="eye-center"/>
              </svg>
              <!-- Ojo cerrado -->
              <svg *ngIf="!showPassword" width="20" height="20" viewBox="0 0 20 20" fill="none" class="eye-svg">
                <path d="M10 4 C6 4 3 6 1 10 C3 14 6 16 10 16 C14 16 17 14 19 10 C17 6 14 4 10 4 Z" 
                      stroke="currentColor" stroke-width="1.5" fill="none" class="eye-outline"/>
                <line x1="4" y1="6" x2="16" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="eye-line"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="form-field">
          <label>Rol *</label>
          <select [(ngModel)]="nuevoUsuario.idRol" name="id_rol" required>
            <option value="0">Seleccione un rol</option>
            <option *ngFor="let rol of roles" [value]="rol.idRol">{{ rol.nombre }}</option>
          </select>
        </div>
        <div class="form-field">
          <label>Fecha de Registro</label>
          <input type="date" [(ngModel)]="nuevoUsuario.fechaRegistro" name="fecha_registro">
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="submit" class="btn-save">Guardar Usuario</button>
        <button type="button" class="btn-cancel" (click)="closeAddModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<!-- Modal Editar Usuario -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeEditModal()">×</button>
    <h2 class="modal-title">Editar Usuario</h2>

    <form class="modal-form" (ngSubmit)="updateUsuario()">
      <div class="form-fields">

        <div class="form-field">
          <label>Nombre Completo *</label>
          <input type="text"
                 [(ngModel)]="nuevoUsuario.nombre"
                 name="nombre"
                 required>
        </div>

        <div class="form-field">
          <label>Email *</label>
          <input type="email"
                 [(ngModel)]="nuevoUsuario.email"
                 name="email"
                 required>
        </div>

        <div class="form-field">
          <label>Rol *</label>
          <select [(ngModel)]="nuevoUsuario.idRol" name="idRol" required>
            <option *ngFor="let rol of roles" [value]="rol.idRol">
              {{ rol.nombre }}
            </option>
          </select>
        </div>

        <div class="form-field">
          <label>Estado</label>
          <select [(ngModel)]="nuevoUsuario.estado" name="estado">
            <option [ngValue]="true">Activo</option>
            <option [ngValue]="false">Inactivo</option>
          </select>
        </div>

      </div>

      <div class="modal-actions">
        <button type="submit" class="btn-save">Guardar Cambios</button>
        <button type="button" class="btn-cancel" (click)="closeEditModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

